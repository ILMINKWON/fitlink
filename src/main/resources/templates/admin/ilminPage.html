<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

  <style>
    nav {
      height: 100vh;
      position: relative;
      overflow-y: auto;
    }

    html, body {
      height: 100%;
    }

    .nav-link {
      padding: 10px 12px;
      border-radius: 8px;
    }
    .nav-link.active {
      background: #8b4de0 !important;
      color: #fff !important;
      font-weight: bold;
    }
    .nav-link:hover {
      background: rgba(139, 77, 224, 0.3);
    }

    /* ì „ì²´ UI ì¶•ì†Œ */
    body, table, .card, .nav-link {
      font-size: 0.85rem !important;
    }

    /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ë†’ì´ ì¤„ì´ê¸° */
    .card {
      padding: 10px !important;
    }
    .card h3 {
      font-size: 1.3rem !important;
    }
    .card h6 {
      font-size: 0.9rem !important;
    }

    .row.g-4 > div {
      margin-bottom: 10px !important;
    }

    /* ì„¹ì…˜ë§ˆë‹¤ ê°„ê²© ì¤„ì´ê¸° */
    section {
      margin-top: 5px !important;
      margin-bottom: 5px !important;
    }

    /* ì¢Œì¸¡ ë©”ë‰´ë„ˆë¹„ â†“ */
    /*nav.col-md-3.col-lg-2 {*/
    /*  flex: 0 0 200px !important;*/
    /*  max-width: 200px !important;*/
    /*}*/

    /* ê·¸ë˜í”„ ì˜ì—­ ì¶•ì†Œ */
    #reservationChart {
      height: 280px !important;
    }

    .text-center.opacity-50.py-5 {
      padding: 10px 0 !important;
    }

    /* ì œëª© í¬ê¸° ì¤„ì´ê¸° */
    h2, h5 {
      font-size: 1.1rem !important;
    }

    /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¤„ë†’ì´ ì¶•ì†Œ */
    .list-group-item {
      padding: 6px 10px !important;
    }

    #notificationBadge {
      font-size: 0.65rem;
      padding: 4px 6px;
      border-radius: 50%;
    }
  </style>

</head>
<body>
  <!--ì›¹ ìš© ê´€ë¦¬ì í˜ì´ì§€ !!!-->

  <div class="container-fluid">
    <div class="row min-vh-100">
      
      <nav class="col-md-2 bg-dark text-white p-4">
        <h4 class="mb-4 d-flex align-items-center justify-content-between">
          <span class="fs-5">ê´€ë¦¬ì ë©”ë‰´</span>
          <span class="position-relative">
            <i id="bellIcon" class="bi bi-bell fs-4" style="cursor:pointer;"></i>
            <span id="notificationBadge"
                  class="badge bg-danger d-none position-absolute"
                  style="top:-8px; right:-10px;">0</span>
          </span>
        </h4>
        <!-- ì•Œë¦¼ì°½ UI ì¶”ê°€ -->
        <div id="notificationBox" class="bg-white border rounded shadow-sm p-3 position-absolute" 
        style="top: 60px; left: 30px; width: 300px; display: none; z-index: 1000;">
        <h6>ì•Œë¦¼ ëª©ë¡</h6>
        <ul id="notificationList" class="list-unstyled mb-0 text-black"></ul>
        </div>
        <ul class="nav flex-column">
          <a class="nav-link text-white" href="#" onclick="showPage('dashboardHome')">
            <i class="bi bi-house-door me-2"></i>ëŒ€ì‹œë³´ë“œ í™ˆ
          </a>
          <!-- <li class="nav-item mb-2">
            <a class="nav-link text-white" href="#"><i class="bi bi-person-plus me-2"></i>ê´€ë¦¬ì ë“±ë¡</a>
          </li>
          <li class="nav-item mb-2">
            <a class="nav-link text-white" href="#"><i class="bi bi-people me-2"></i>íšŒì› ê´€ë¦¬</a>
          </li> -->
          <a class="nav-link text-white" href="#" onclick="showPage('trainerRegister')">
            <i class="bi bi-building-fill-add me-2"></i> ì§€ë„ì ë“±ë¡
          </a>
          <a class="nav-link text-white" href="#" onclick="trainerCountCard()">
            <i class="bi bi-building me-2"></i> ê°€ì… ëª©ë¡ í˜„í™©
          </a>
        </ul>
      </nav>

      <main class="col-md-10 p-5">
        <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
        <section id="dashboardHome" style="display: none;">
            <h2 class="mb-4 fw-bold" style="color:#6a07e2;">ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>

            <div class="row g-4 mb-4">
              <!-- ì¹´ë“œ 1 -->
              <div class="col-md-3" onclick="trainerCountCard()">
                <div class="card shadow text-white p-3" style="background: #8b4de0; cursor: pointer;">
                  <h6 class="fw-semibold">ì´ ì§€ë„ì ìˆ˜</h6>
                  <h3 class="display-6 fw-bold" id="cntTrainer">0</h3>
                  <i class="bi bi-person-badge fs-2 opacity-75"></i>
                </div>
              </div>

              <!-- ì¹´ë“œ 2 -->
              <div class="col-md-3" onclick="memberCountCard()">
                <div class="card shadow text-white p-3" style="background: #a66bf7; cursor: pointer;">
                  <h6 class="fw-semibold">ì´ íšŒì› ìˆ˜</h6>
                  <h3 class="display-6 fw-bold" id="cntMember">0</h3>
                  <i class="bi bi-people fs-2 opacity-75"></i>
                </div>
              </div>

              <!-- ì¹´ë“œ 3 -->
              <div class="col-md-3">
                <div class="card shadow text-white p-3" style="background: #9a62f0;">
                  <h6 class="fw-semibold">ì˜¤ëŠ˜ ì˜ˆì•½</h6>
                  <h3 class="display-6 fw-bold" id="cntToday">0</h3>
                  <i class="bi bi-calendar-check fs-2 opacity-75"></i>
                </div>
              </div>

              <!-- ì¹´ë“œ 4 -->
              <div class="col-md-3" onclick="trainerRank();">
                <div class="card shadow text-white p-3" style="background: #b487ff; cursor: pointer;">
                  <h6 class="fw-semibold">ì›”ê°„ ì˜ˆì•½ 1ë“±</h6>
                  <h3 class="display-6 fw-bold" id="topRankName">-</h3>
                  <i class="bi bi-trophy fs-2 opacity-75"></i>
                </div>
              </div>
            </div>

            <div class="card shadow-sm p-4 mt-4" style="border-left: 6px solid #8b4de0;">
              <h5 class="fw-bold" style="color:#6a07e2;">ì˜ˆì•½ í˜„í™© ê·¸ë˜í”„</h5>
              <div class="text-center opacity-50 py-5">
                <i class="bi bi-bar-chart-line fs-1"></i>
                <canvas id="reservationChart" height="120"></canvas>
              </div>
            </div>

<!--           <ì§€ë„ì>-->
            <div class="card shadow-sm p-4 mt-4" style="border-left: 6px solid #8b4de0;">
              <h5 class="fw-bold" style="color:#6a07e2;">ìµœê·¼ ê°€ì… ì§€ë„ì</h5>
              <ul class="list-group mt-3" id="recentList">
              </ul>
            </div>
          </section>


        <!-- ì§€ë„ì ë“±ë¡ í™”ë©´ -->
        <section id="trainerRegister">
          <h2 class="mb-4">ì§€ë„ì ë“±ë¡</h2>
          <p>â€» ì§€ë„ìê°€ ë“±ë¡ë˜ë©´ ì½”ë“œë²ˆí˜¸ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
            <form>
              <div class="mb-3 position-relative">
                <label for="adminName" class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control" id="adminName" autocomplete="off" placeholder="ì§€ë„ì ì´ë¦„">
                <ul id="suggestionList" class="list-group position-absolute w-100" style="z-index: 2000;"></ul>
              </div>
              <div class="mb-3">
                <label for="adminPhone" class="form-label">ì „í™”ë²ˆí˜¸</label>
                <input type="phone" class="form-control" id="adminPhone" placeholder="ì§€ë„ì ì „í™”ë²ˆí˜¸">
              </div>
              <div class="mb-3">
                <label for="adminCode" class="form-label">ìƒì„±ëœ ì½”ë“œ</label>
                <input type="text" class="form-control" id="adminCode">
              </div>
              <div class="mb-3">
                <label for="adminEmail" class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" id="adminEmail" placeholder="ì§€ë„ì ì´ë©”ì¼">
              </div>
              <button type="submit" class="btn btn-primary">ì½”ë“œì „ì†¡</button>
            </form>
        </section>
        <!-- íšŒì› ëª©ë¡ ì¹´ë“œ-->
        <section id="customerListSection" style="display:none;">
          <h2 class="mb-4 fw-bold" style="color:#6a07e2;">íšŒì› ëª©ë¡</h2>
          <div id="customerListContent"></div>
          <nav id="memberPaginationContainer"></nav>
        </section>

        <!-- ì„ ìƒë‹˜ ìˆœìœ„-->
        <section id="trainerRankSection" style="display:none;">
          <h2 class="mb-4 fw-bold" style="color:#6a07e2;">íŠ¸ë ˆì´ë„ˆ ì›”ê°„ ì˜ˆì•½ ìˆœìœ„</h2>
          <div id="trainerRankContent"></div>
          <nav id="trainerRankPaginationContainer"></nav>
        </section>

        <!--ê°€ì… ëª©ë¡ í˜„í™©-->
<!--        <section id = "trainerRegisterList" style="display:none;">-->
<!--          <h2 class="mb-4">ê°€ì… ëª©ë¡ í˜„í™©</h2>-->
<!--        </section>-->
      </main>

      <div id="adminContainer" data-admin-id="1"></div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    document.querySelector("form").addEventListener("submit", function (e) {
      e.preventDefault();

      const email = document.getElementById("adminEmail").value;
      const code = document.getElementById("adminCode").value;

      if (!email || !code) {
        alert("ì´ë©”ì¼ ë˜ëŠ” ì½”ë“œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      sendCodeByEmail(email, code);
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
    const socket = new SockJS("/ws-chat");
    const stompClient = Stomp.over(socket);

    const bellIcon = document.getElementById("bellIcon");
    const badge = document.getElementById("notificationBadge");
    const notificationBox = document.getElementById("notificationBox");
    const notificationList = document.getElementById("notificationList");

    const adminId = document.getElementById("adminContainer").dataset.adminId;

    function showNotification(message) {
      console.log("ìƒˆ ì•Œë¦¼:", message);

      // ì¢…ëª¨ì–‘ ë³€ê²½, ë°°ì§€ ì¦ê°€
      bellIcon.classList.remove("bi-bell");
      bellIcon.classList.add("bi-bell-fill");
      badge.textContent = parseInt(badge.textContent || "0") + 1;
      badge.classList.remove("d-none");

      // ì•Œë¦¼ ëª©ë¡ì— ì¶”ê°€
      const li = document.createElement("li");
      li.textContent = message;
      li.classList.add("border-bottom", "py-2");
      notificationList.prepend(li); // ìµœì‹ ìˆœ
    }

    // ì¢… í´ë¦­ ì‹œ ì•Œë¦¼ì°½ í† ê¸€
    bellIcon.addEventListener("click", () => {
      const isHidden = notificationBox.style.display === "none";
      notificationBox.style.display = isHidden ? "block" : "none";

      if (isHidden) {
        // ì—´ë¦´ ë•Œ ë°°ì§€ ì´ˆê¸°í™”, ì¢…ëª¨ì–‘ ë³€ê²½
        badge.textContent = "0";
        badge.classList.add("d-none");
        bellIcon.classList.remove("bi-bell-fill");
        bellIcon.classList.add("bi-bell");
      }
    });

    stompClient.connect({}, () => {
      stompClient.subscribe(`/topic/notifications/${adminId}`, (message) => {
        const body = JSON.parse(message.body);
        showNotification(body.message);
      });

      // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
      showNotification("í…ŒìŠ¤íŠ¸ ì•Œë¦¼: í•œ ëª…ì˜ ì§€ë„ìê°€ íšŒì›ê°€ì… í•˜ì˜€ìŠµë‹ˆë‹¤.");
    });
  });
  </script>
  <script>
    const nameInput = document.getElementById("adminName");
    const phoneInput = document.getElementById("adminPhone");
    const codeInput = document.getElementById("adminCode");
    const suggestionList = document.getElementById("suggestionList");

    function generateRandomCode(length = 6) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < length; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    nameInput.addEventListener("input", async () => {
      const keyword = nameInput.value.trim();
      if (keyword.length < 1) {
        suggestionList.innerHTML = "";
        return;
      }

      try {
        const response = await fetch(`/api/leaders/search?keyword=${encodeURIComponent(keyword)}`);
        const results = await response.json();

        suggestionList.innerHTML = "";
        results.forEach(item => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          li.textContent = `${item.name} (${item.phone}) ${item.email}`;
          
          li.addEventListener("click", () => {
            nameInput.value = item.name;
            phoneInput.value = item.phone;
            document.getElementById("adminEmail").value = item.email; // â† ì´ë©”ì¼ë„ ì±„ìš°ê¸°
            codeInput.value = generateRandomCode(); // â† ì½”ë“œ ìë™ ìƒì„±
            suggestionList.innerHTML = "";
          });

          suggestionList.appendChild(li);
        });
      } catch (error) {
        console.error("ìë™ì™„ì„± ì˜¤ë¥˜:", error);
      }
    });
  </script>
  <script>
    async function sendCodeByEmail(email,code){
          try{
            const response = await fetch("/api/email/send-code", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({ email, code })
        });

        const result = await response.text();
        alert(result);
      } catch (error) {
        console.error("ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:", error);
      }
    }

    async function showPage(pageId){
      // ëª¨ë“  í™”ë©´ ìˆ¨ê¹€
      document.querySelectorAll("main section").forEach(sec => sec.style.display = "none");
      document.getElementById(pageId).style.display = "block";

      // ì¢Œì¸¡ ë©”ë‰´ active í‘œì‹œ ë³€ê²½
      document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));

      if(event && event.target){
        event.target.classList.add("active");
      }


      if(pageId === "dashboardHome"){
        await loadDashboardData();
        await loadReservationChart();
        await loadRecentTrainers();
      }
    }

    async function loadDashboardData(){
      try{
        const res = await fetch('/fitLink/api/dashboard/data');
        const data = await res.json();

        document.getElementById("cntTrainer").innerText = data.trainerCount + "ëª…";
        document.getElementById("cntMember").innerText =  data.memberCount + "ëª…";
        document.getElementById("topRankName").innerText = data.topRank;
        document.getElementById("cntToday").innerText = data.reservationToday + "ê±´";
      } catch (e){
        console.log("ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨:", e);
      }
    }

    function trainerCountCard(){
        window.location.href = "/fitLink/trainers?page=1";
    }

    async function loadCustomerList(page = 1){
      try{
        const res = await fetch(`/fitLink/api/customer?page=${page}`);
        const data = await res.json();

        renderCustomerTable(data);
        showPage('customerListSection');

      }catch (e) {
        console.error("íšŒì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨", e);
      }
    }

    function renderCustomerTable(data){
      const target = document.getElementById("customerListContent");


      let html = `
      <table class="table table-hover text-center align-middle shadow-sm">
          <thead class="table-light">
          <tr>
              <th>#</th>
              <th>ì´ë¦„</th>
              <th>ì „í™”ë²ˆí˜¸</th>
              <th>ê°€ì…ì¼</th>
          </tr></thead><tbody>
      `;

        data.list.forEach((m, i) => {
          const num = (data.currentPage - 1) * 5 + (i + 1);
          html += `
          <tr>
              <td>${num}</td>
              <td>${m.name}</td>
              <td>${m.phone}</td>
              <td>${m.createdAt || '-'}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
        target.innerHTML = html;
      console.log(data.list[0]);

        renderMemberPagination(data.currentPage, data.totalPages);
    }

    function renderMemberPagination(currentPage, totalPages){
      const pageBox = document.getElementById("memberPaginationContainer");
      let html = `<ul class="pagination justify-content-center">`;

      if(currentPage > 1){
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomerList(${currentPage-1})">&laquo;</a></li>`;
      }

      for(let p=1; p<=totalPages; p++){
        html += `<li class="page-item ${p==currentPage?'active':''}">
                    <a class="page-link" href="#" onclick="loadCustomerList(${p})">${p}</a>
                </li>`;
      }

      if(currentPage < totalPages){
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomerList(${currentPage+1})">&raquo;</a></li>`;
      }

      html += `</ul>`;
      pageBox.innerHTML = html;
    }

    function memberCountCard(){
      loadCustomerList(1);
    }

    //1í˜ì´ì§€ë¶€í„° ì‹œì‘.
    function trainerRank(){
      loadRankList(1);
    }
    async function loadRankList(page = 1){
      try{
        const res = await fetch(`/fitLink/api/rank?page=${page}`);
        const data = await res.json();

        renderRankTable(data);
        showPage('trainerRankSection');
      } catch (e) {
        console.error("ë¡œë”© ì‹¤íŒ¨",e);
      }
    }

    function renderRankTable(data){
      const target = document.getElementById("trainerRankContent");

      let html = `
        <table class="table table-hover text-center align-middle shadow-sm">
          <thead class="table-light">
            <tr>
              <th>ìˆœìœ„</th>
              <th>ì´ë¦„</th>
              <th>ì§€ì </th>
              <th>ì´ë²ˆë‹¬ ì˜ˆì•½ ìˆ˜</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.list.forEach((t,i) => {
        const rank = (data.currentPage - 1) * 5 + (i + 1);
        html += `
          <tr>
            <td>${rank}</td>
            <td>${t.name}</td>
            <td>${t.workplaceName || '-'}</td>
            <td>${t.reservationCount || 0}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      target.innerHTML = html;

      renderTrainerRankPagination(data.currentPage, data.totalPages);
    }

    function renderTrainerRankPagination(currentPage, totalPages) {
      const pageBox = document.getElementById("trainerRankPaginationContainer");
      let html = `<ul class="pagination justify-content-center">`;

      if (currentPage > 1) {
        html += `
      <li class="page-item">
        <a class="page-link" href="#" onclick="loadRankList(${currentPage - 1})">&laquo;</a>
      </li>`;
      }

      for (let p = 1; p <= totalPages; p++) {
        html += `
      <li class="page-item ${p === currentPage ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadRankList(${p})">${p}</a>
      </li>`;
      }

      if (currentPage < totalPages) {
        html += `
      <li class="page-item">
        <a class="page-link" href="#" onclick="loadRankList(${currentPage + 1})">&raquo;</a>
      </li>`;
      }

      html += `</ul>`;
      pageBox.innerHTML = html;
    }


    //ì˜ˆì•½ ì°¨íŠ¸ ê·¸ë˜í”„
    let chart; // ì „ì—­ ìœ ì§€

    // ğŸ“Œ ì˜ˆì•½ ê·¸ë˜í”„ ë¡œë“œ í•¨ìˆ˜
    async function loadReservationChart() {
      try {
        const res = await fetch("/fitLink/api/dashboard/chart");
        const data = await res.json();

        const ctx = document.getElementById('reservationChart').getContext('2d');

        if (chart) chart.destroy(); // ê¸°ì¡´ ê·¸ë˜í”„ ì œê±°

        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels, // ["03-01", "03-02", ...]
            datasets: [{
              label: "ì¼ë³„ ì˜ˆì•½ ìˆ˜",
              data: data.values, // [4, 7, 2, 9, 3...]
              backgroundColor: "#7532d2"
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });

      } catch (e) {
        console.error("ê·¸ë˜í”„ ë¡œë”© ì‹¤íŒ¨", e);
      }
    }

    async function loadRecentTrainers(){
      try {
        const res = await fetch("/fitLink/api/recent-trainers");
        const data = await res.json();

        const list = document.getElementById("recentList");
        list.innerHTML = "";

        data.forEach(t => {
          const li = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${t.name}
                <span class="badge bg-light text-dark">${(t.createdAt || '').substring(0,10)}</span>
            </li>`;
          list.insertAdjacentHTML("beforeend", li);
        });
      } catch(e) {
        console.error("ìµœê·¼ ì§€ë„ì ëª©ë¡ ì‹¤íŒ¨:", e);
      }
    }
  </script>

</body>
</html>
