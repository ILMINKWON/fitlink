<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        /* ë¡œê³  ìŠ¤íƒ€ì¼ */
        .fit-logo {
            font-size: 4rem;
            font-weight: 800;
            color: #6a07e2;
            text-align: center;
            margin-top: 30px;
            animation: shimmer 2s infinite;
            background: linear-gradient(90deg, #8814ac, #66b2ff, #8814ac);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu-box {
            border: 2px solid #6a07e2;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            font-size: 1.4rem;
            font-weight: bold;
            color: #6a07e2;
            transition: 0.3s ease-in-out;
        }
        .menu-box:hover {
            background-color: #6a07e2;
            color: white;
            transform: translateY(-3px);
        }

        .menu-box.active {
            background-color: #6a07e2;
            color: white;
        }

        .tab-content-box {
            display: none;
            width: 100%;
            max-width: 600px; /* ì›í•˜ëŠ” ë„ˆë¹„ ì¡°ì ˆ */
            margin: 30px auto; /* ê°€ìš´ë° ì •ë ¬ */
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 12px;
        }
    </style>
</head>

<body>

<div class="container-fluid container-mv" style="margin-top: 100px;">
    <div class="row">
        <div class="col text-end"
             th:utext="'<b>' + ${admin.name} + '</b>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤.'">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="fit-logo mb-5">Fit Link.</div>
        </div>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ ë©”ë‰´ -->
    <div class="row justify-content-center">
        <div class="col-10 col-md-4 mb-3">
            <div id ="customerTab" class="menu-box" onclick="showTab('customer')">
                ìˆ˜ê°•ìƒ ê´€ë¦¬
            </div>
        </div>
        <div class="col-10 col-md-4 mb-3">
            <div id="scheduleTab" class="menu-box" onclick="showTab('schedule')">
                ìˆ˜ì—… ë“±ë¡ ë° ì¼ì • ê´€ë¦¬
            </div>
        </div>
    </div>

    <!-- íƒ­ ë‚´ìš© ì˜ì—­ -->
    <div id="customerContent" class="tab-content-box justify-content-center">
        <h4>ìˆ˜ê°•ìƒ ê´€ë¦¬</h4>
        <ul>
            <li>íšŒì› ê´€ë¦¬</li>
            <li>ì‹¤ì‹œê°„ ì±„íŒ… ì—°ê²°</li>
        </ul>
    </div>

    <div id="scheduleContent" class="tab-content-box justify-content-center">
        <ul>
            <li>
                <button type="button" class="btn fw-bold" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                    ìˆ˜ì—… ë“±ë¡ ë° ì¼ì • ê´€ë¦¬
                </button>
            </li>
        </ul>
    </div>

</div>

<script th:inline="javascript">
    const adminName = /*[[${admin.name}]]*/ "ê´€ë¦¬ì";
    const adminEmail = /*[[${admin.email}]]*/ "";
    const adminId = /*[[${admin.id}]]*/ 0;

    console.log("ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ì •ë³´ â–¼");
    console.log("ê´€ë¦¬ì ì´ë¦„:", adminName);
    console.log("ê´€ë¦¬ì ì´ë©”ì¼:", adminEmail);
    console.log("ê´€ë¦¬ì ID:", adminId);
</script>

<script>
    function showTab(tabName){
        // ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¹€
        document.getElementById("customerContent").style.display = "none";
        document.getElementById("scheduleContent").style.display = "none";

        // ëª¨ë“  ë²„íŠ¼ active ì œê±°
        document.getElementById("customerTab").classList.remove("active");
        document.getElementById("scheduleTab").classList.remove("active");

        // ì–´ëŠ íƒ­ì´ í´ë¦­ë˜ì—ˆëŠ”ì§€ì— ë”°ë¼ ë‹¤ë¥¸ ì½˜í…ì¸  + ë‹¤ë¥¸ íƒ­ ë²„íŠ¼ì„ í™œì„±í™”
        if(tabName === "customer"){
            document.getElementById("customerContent").style.display = "block";
            document.getElementById("customerTab").classList.add("active");
        } else{
            document.getElementById("scheduleContent").style.display = "block";
            document.getElementById("scheduleTab").classList.add("active");
        }
    }

    showTab("customer");

</script>
<script>
    let currentYear;
    let currentMonth; // 0 ~ 11
    let selectedDate = null;

    const today = new Date();
    const todayYear = today.getFullYear();
    const todayMonth = today.getMonth();
    const todayDate = today.getDate();

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
        const now = new Date();
        currentYear = now.getFullYear();
        currentMonth = now.getMonth();
        renderCalendar();
    }

    // ë‹¬ë ¥ ë Œë”ë§
    let adminReservations = [];   // ğŸ”¹ ì „ì—­ì— ì¶”ê°€ (renderCalendar ìœ„ì— ë‘ë©´ ë” ì¢‹ìŒ)

    // ë‹¬ë ¥ ë Œë”ë§
    function renderCalendar() {
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);

        const calendarBody = document.getElementById("calendarBody");
        const title = document.getElementById("calendarTitle");

        title.textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;
        calendarBody.innerHTML = "";

        let row = document.createElement("tr");

        // ì²« ì£¼ ì•ë¶€ë¶„ ë¹ˆì¹¸
        for (let i = 0; i < firstDay.getDay(); i++) {
            row.appendChild(document.createElement("td"));
        }

        for (let date = 1; date <= lastDay.getDate(); date++) {
            const cell = document.createElement("td");
            cell.textContent = date;
            cell.style.cursor = "pointer";

            const cellDate = new Date(currentYear, currentMonth, date);
            const dayOfWeek = new Date(currentYear, currentMonth, date).getDay(); // 0~6

            // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œë©´ ë¹„í™œì„±í™”
            if (cellDate < new Date(todayYear, todayMonth, todayDate)) {
                cell.classList.add("text-muted"); // íë¦¬ê²Œ
                cell.style.pointerEvents = "none"; // í´ë¦­ ë§‰ê¸°
            } else {
                // ğŸ”¥ í™œì„± ë‚ ì§œë§Œ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
                cell.style.cursor = "pointer";
                cell.addEventListener("click", () => selectDate(date, cell));
            }

            // ğŸ“ ìš”ì¼ë³„ ìƒ‰ìƒ ì„¤ì •
            if (dayOfWeek === 0) {      // ì¼ìš”ì¼
                cell.style.color = "red";
            } else if (dayOfWeek === 6) { // í† ìš”ì¼
                cell.style.color = "blue";
            }

            const y = currentYear;
            const m = String(currentMonth + 1).padStart(2, "0");
            const d = String(date).padStart(2, "0");
            const dateStr = `${y}-${m}-${d}`;

            // âœ… ì˜¤ëŠ˜ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸
            if (currentYear === todayYear &&
                currentMonth === todayMonth &&
                date === todayDate) {
                cell.classList.add("table-primary");
                cell.classList.add("fw-bold");
            }

            // âœ… ì´ ë‚ ì§œì— ì˜ˆì•½ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìƒ‰ í‘œì‹œ
            const hasReserved = adminReservations.some(r => r.checkIn.startsWith(dateStr));
            if (hasReserved) {
                cell.classList.add("table-warning");
            }

            // âœ… í´ë¦­ ì‹œ ì˜ˆì•½ ëª©ë¡ + ë©”ëª¨ ë¡œì§ ì‹¤í–‰
            cell.addEventListener("click", () => selectDate(date, cell));

            row.appendChild(cell);

            // ì£¼ê°€ ëë‚˜ë©´ ì¤„ ë°”ê¿ˆ
            if ((firstDay.getDay() + date) % 7 === 0) {
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }

        // ë‚¨ì€ ì¹¸ ì¶”ê°€
        if (row.children.length > 0) {
            calendarBody.appendChild(row);
        }
    }


    // ë‚ ì§œ ì„ íƒ
    function selectDate(day, cell) {
        selectedDate = new Date(currentYear, currentMonth, day);

        const y = selectedDate.getFullYear();
        const m = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const d = String(selectedDate.getDate()).padStart(2, '0');
        const dateStr = `${y}-${m}-${d}`;

        document.getElementById("selectedDateText").textContent =
            `ì„ íƒëœ ë‚ ì§œ: ${dateStr}`;

        // ê¸°ì¡´ ì„ íƒ ì œê±° í›„ ì„ íƒ í‘œì‹œ
        document.querySelectorAll("#calendarBody td").forEach(td => {
            td.classList.remove("table-success");
        });
        cell.classList.add("table-success");

        // ë©”ëª¨ ì²˜ë¦¬
        const key = getMemoKey(selectedDate);
        document.getElementById("memoText").value = localStorage.getItem(key) || "";

        // ğŸ”¥ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        const listTitle = document.getElementById("reservationListTitle");
        const listContainer = document.getElementById("reservationList");
        listContainer.innerHTML = "";

        const reservations = adminReservations.filter(r => r.checkIn.startsWith(dateStr));
        console.log(adminReservations + "<<<<<<");


        if (reservations.length === 0) {
            listTitle.textContent = "ì˜ˆì•½ ì—†ìŒ";
            return;
        }

        listTitle.textContent = `ì˜ˆì•½ ëª©ë¡ (${reservations.length})`;
        reservations.forEach(r => {
            console.log(reservations);
            const time = r.checkIn.substring(11, 16);
            const userName  = r.userName  ?? r.user_name  ?? "ì´ë¦„ ì—†ìŒ";
            const userPhone = r.userPhone ?? r.user_phone ?? "ë²ˆí˜¸ ì—†ìŒ";

            listContainer.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    â± ${time} / ğŸ‘¤ ${userName} / ğŸ“ ${userPhone}
                </div>
                <button class="btn btn-sm btn-danger" onclick="cancelReservation(${r.id})">
                    ì·¨ì†Œ
                </button>
            </li>
        `;
        });
    }


    function getMemoKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `fitlink-memo-${adminId}-${y}-${m}-${d}`;
    }

    function saveMemo() {
        if (!selectedDate) {
            alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
            return;
        }
        try{
            const memo = document.getElementById("memoText").value;
            const key = getMemoKey(selectedDate);
            localStorage.setItem(key, memo);
            alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
            console.error("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨: ", e);
            alert("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
        }

    }

    function changeMonth(offset) {
        currentMonth += offset;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        selectedDate = null;
        document.getElementById("selectedDateText").textContent = "ì„ íƒëœ ë‚ ì§œ: ì—†ìŒ";
        document.getElementById("memoText").value = "";
        renderCalendar();
    }

    // ëª¨ë‹¬ì´ ì²˜ìŒ ì—´ë¦´ ë•Œ ë‹¬ë ¥ ì´ˆê¸°í™”
    // ğŸ”¹ ì´ë¯¸ ìœ„ì—ì„œ let adminReservations = []; ì„ ì–¸í•œ ìƒíƒœë¼ê³  ê°€ì •

    document.addEventListener("DOMContentLoaded", () => {
        const scheduleModal = document.getElementById("scheduleModal");
        if (!scheduleModal) return;

        scheduleModal.addEventListener("shown.bs.modal", async () => {
            // 1) ë‹¬ë ¥ ì´ˆê¸°í™” (ìµœì´ˆ í•œ ë²ˆ)
            if (currentYear === undefined) {
                const now = new Date();
                currentYear = now.getFullYear();
                currentMonth = now.getMonth();
            }

            // 2) ì´ íŠ¸ë ˆì´ë„ˆì˜ ì „ì²´ ì˜ˆì•½ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            try {
                const res = await fetch(`/fitLink/api/reservation/admin?adminId=${adminId}`);
                adminReservations = await res.json();
                console.log("ê´€ë¦¬ì ì˜ˆì•½ ëª©ë¡:", adminReservations);
            } catch (e) {
                console.error("ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", e);
                adminReservations = [];
                alert("ì„œë²„ì—ì„œ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }

            // 3) ì˜ˆì•½ ì •ë³´ ë°˜ì˜í•´ì„œ ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¼
            renderCalendar();
        });
    });

    function cancelReservation(id) {
        if (!confirm("ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/fitLink/api/reservation/cancel/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (!res.ok) throw new Error("ì·¨ì†Œ ì‹¤íŒ¨");
                alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // ğŸ”¥ ëª¨ë‹¬ ë‹«ê¸°
                const modalEl = document.getElementById("scheduleModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // ğŸ”¥ ëª¨ë‹¬ ë‹«íŒ ë’¤, ì˜ˆì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì¤€ë¹„
                return fetch(`/fitLink/api/reservation/admin?adminId=${adminId}`,{
                    method: "GET"
                });
            })
            .then(res => res.json())
            .then(data => {
                adminReservations = data;
                // ë‹¤ìŒ ë²ˆì— ëª¨ë‹¬ ë‹¤ì‹œ ì—´ë©´ ìµœì‹  ì˜ˆì•½ ë°˜ì˜ë¨
            })
            .catch(err => {
                console.error(err);
                alert("ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            });
    }

</script>


<!-- ìˆ˜ì—… ì¼ì • ìº˜ë¦°ë” ëª¨ë‹¬ -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìˆ˜ì—… ì¼ì • ìº˜ë¦°ë”</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ë‹¬ë ¥ ìƒë‹¨ (ì›” ì´ë™) -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)">â€¹ ì´ì „</button>
                    <h5 id="calendarTitle" class="mb-0"></h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)">ë‹¤ìŒ â€º</button>
                </div>

                <!-- ë‹¬ë ¥ í…Œì´ë¸” -->
                <table class="table table-bordered text-center mb-3">
                    <thead>
                    <tr>
                        <th>ì¼</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                        <th>í† </th>
                    </tr>
                    </thead>
                    <tbody id="calendarBody">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>

                <!-- ì„ íƒ ë‚ ì§œ ë©”ëª¨ ì˜ì—­ -->
                <div>
                    <h6 id="selectedDateText">ì„ íƒëœ ë‚ ì§œ: ì—†ìŒ</h6>
                    <textarea id="memoText" class="form-control" rows="3"
                              placeholder="í•´ë‹¹ ë‚ ì§œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                    <button class="btn btn-primary mt-2" onclick="saveMemo()">ë©”ëª¨ ì €ì¥</button>
                </div>
                <h6 id="reservationListTitle" class="mt-3"></h6>
                <ul id="reservationList" class="list-group"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
