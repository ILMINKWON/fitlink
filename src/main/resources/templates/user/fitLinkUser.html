<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <!--ë·° í¬íŠ¸ ì„¤ì •-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        .material-icons {
            font-size: 50px;
            display: block;
            margin-bottom: 10px;
        }

        /* ë¡œê³  ìŠ¤íƒ€ì¼ */
        .fit-logo {
            font-size: 4rem;
            font-weight: 800;
            color: #6a07e2;
            text-align: center;
            margin-top: 30px;
            animation: shimmer 2s infinite;
            background: linear-gradient(90deg, #8814ac, #66b2ff, #8814ac);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ë°˜ì§ë°˜ì§ íš¨ê³¼ */
        @keyframes shimmer {
            0% {
                background-position: -300px 0;
            }
            100% {
                background-position: 300px 0;
            }
        }
    </style>

    <!-- Kakao Map -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5fc3ddce96acbc8d29ced7d741b2b26c&libraries=services"></script>
</head>
<body>
    <div class="container-fluid container-mv" style="margin-top: 100px;">
        <div class="row">
            <div class="col">
                <div class="fit-logo mb-4" onclick="location.href='/fitLink/fitLinkUser'">Fit Link.</div>
            </div>
        </div>
    </div>
    <div class="container mb-5">

        <h2 class="fw-bold text-center mb-4">ë‚´ ì£¼ë³€ ê²€ì¦ëœ PT</h2>

        <!-- í•„í„° : ì‹œ/ë„ + ì„±ë³„ -->
        <div class="row g-2 justify-content-center mb-3">
            <div class="col-6 col-md-3">
                <select id="select-workplace" class="form-select">
                    <option value="">ì „ì²´ ì§€ì—­</option>
                    <!-- ì‹œ/ë„ëŠ” ì‰½ê²Œ í•˜ë ¤ê³  í•˜ë“œì½”ë”© ì˜ˆì‹œ, ë‚˜ì¤‘ì— DBì—ì„œ ë¿Œë ¤ë„ ë¨ -->
                    <option value="1">ì„œìš¸</option>
                    <option value="2">ê²½ê¸°</option>
                    <option value="3">ì¸ì²œ</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <select id="select-gender" class="form-select">
                    <option value="">ì„±ë³„ ì „ì²´</option>
                    <option value="ë‚¨">ë‚¨ PT</option>
                    <option value="ì—¬">ì—¬ PT</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <select id="select-favorite" class="form-select">
                    <option value="">ì „ë¬¸ì„± ì„ íƒ</option>
                    <option value="ì²´í˜•êµì •">ì²´í˜•êµì •</option>
                    <option value="ë‹¤ì´ì–´íŠ¸">ë‹¤ì´ì–´íŠ¸</option>
                    <option value="ê±´ê°•">ê±´ê°•</option>
                    <option value="ë°”ë””í”„ë¡œí•„ & ëŒ€íšŒ">ë°”ë””í”„ë¡œí•„ & ëŒ€íšŒ</option>
                    <option value="ê·¼ë ¥ì¦ê°€ & ì²´ì¤‘ì¦ê°€">ê·¼ë ¥ì¦ê°€ & ì²´ì¤‘ì¦ê°€</option>
                </select>
            </div>
<!--            <div class="col-12 col-md-3">-->
<!--                <button class="btn btn-outline-primary w-100" id="btn-nearby">-->
<!--                    ê²€ìƒ‰-->
<!--                </button>-->
<!--            </div>-->
        </div>

        <!-- ì§€ë„ + ë¦¬ìŠ¤íŠ¸ -->
        <div class="row">
            <div class="col-md-7 mb-3">
                <div id="map"></div>
            </div>
            <div class="col-md-5" style="max-height:500px; overflow-y:auto;">
                <div id="list"></div>
            </div>
        </div>

    </div>

    <script>
        let map, geocoder;
        let markers = [];
        let infowindows = [];

        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(37.5662952, 126.9779451),
            level: 8
        };

        function initializeMap() {
            mapContainer.style.height = '500px';
            map = new kakao.maps.Map(mapContainer, mapOption);
            geocoder = new kakao.maps.services.Geocoder();

            map.relayout();

            applyFilters();   // ì‹œì‘í•  ë•Œ 1ë²ˆ ì‹¤í–‰
        }

        // ---------------------------
        //  PT ë¦¬ìŠ¤íŠ¸ + ë§ˆì»¤ ë Œë”ë§
        // ---------------------------
        function renderMarkersAndList(data) {
            markers.forEach(marker => marker.setMap(null));
            infowindows.forEach(iw => iw.close());

            markers = [];
            infowindows = [];

            const listElement = document.getElementById('list');
            listElement.innerHTML = '';

            let bounds = new kakao.maps.LatLngBounds();

            data.forEach(item => {

                console.log(item.certificateFileName);

                const position = new kakao.maps.LatLng(item.lat, item.lng);

                // ë§ˆì»¤ ìƒì„±
                const marker = new kakao.maps.Marker({
                    map: map,
                    position: position,
                    title: item.workplaceName
                });
                markers.push(marker);

                // ì¸í¬ìœˆë„ìš°
                const infowindow = new kakao.maps.InfoWindow({
                    content: `<div style="padding:5px;">${item.workplaceName}</div>`
                });
                infowindows.push(infowindow);

                kakao.maps.event.addListener(marker, "click", () => {
                    infowindows.forEach(iw => iw.close());
                    infowindow.open(map, marker);
                });

                // ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
                listElement.innerHTML += `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">${item.workplaceName}</h5>

                            <button class="btn btn-sm btn-danger fw-bold"
                                    onclick="reservation(${item.id}, '${item.name}')">
                                ìˆ˜ì—… ì˜ˆì•½ / ì¶”í›„ ì˜ˆì•½ê¸ˆ (ìœ„ì•½ê¸ˆ) ë°›ì•„ì•¼í•¨.
                            </button>
                        </div>
                        <div><span class="fw-bold fs-3">${item.name}</span></div>
                        <span class="fs-5" style="cursor:pointer; color:#666;" onclick="openReviews(${item.id})">(${item.reviewCount})</span>
                        <p class="card-text mb-1">
                            <span class="badge ${item.gender === 'ë‚¨' ? 'text-bg-primary' : 'text-bg-danger'}">
                                ${item.gender}
                            </span>
                            <span class="badge text-bg-secondary">${item.specialty}</span>
                        </p>
                        <p class="text-muted small">${item.address}</p>
                        <a href="#" class="btn btn-sm btn-outline-info float-end ms-2"
                           onclick="openChat(${item.id}, '${item.name}'); return false;">
                           ì±„íŒ…
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-info float-end ms-2"
                             onclick="openCertificateModal('${item.certificateFileName || ""}'); return false;">
                             ìê²©ì¦ì„œ ë³´ê¸°
                         </a>
                        <a href="#" class="btn btn-sm btn-outline-info float-end"
                           onclick="moveTo(${item.lat}, ${item.lng}); return false;">
                           ì§€ë„ì—ì„œ ë³´ê¸°
                        </a>
                    </div>
                </div>
            `;

                bounds.extend(position);
            });

            if (data.length > 0 && markers.length > 0) {
                const center = bounds.getCenter();
                map.setCenter(center);
                map.setLevel(6);
            } else {
                listElement.innerHTML = `<p class="text-center text-muted mt-5">
                ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì„ ìƒë‹˜ì´ ì—†ìŠµë‹ˆë‹¤.
            </p>`;
            }
        }

        function moveTo(lat, lng) {
            map.panTo(new kakao.maps.LatLng(lat, lng));
        }

        // ---------------------------
        //  ì„œë²„ë¡œ ë°ì´í„° ìš”ì²­
        // ---------------------------
        async function applyFilters() {
            const workplace = document.getElementById('select-workplace').value;
            const gender = document.getElementById('select-gender').value;
            const specialty = document.getElementById('select-favorite').value;

            const params = new URLSearchParams();
            if (workplace) params.append("workplaceId", workplace);
            if (gender) params.append("gender", gender);
            if (specialty) params.append("specialty", specialty);

            const response = await fetch(`/fitLink/api/admin/search?` + params.toString());
            const data = await response.json();

            console.log("ì„œë²„ì—ì„œ ë°›ì€ JSON:", data);

            renderMarkersAndList(data);
        }

        // ---------------------------
        // ì´ë²¤íŠ¸ ë“±ë¡
        // ---------------------------
        document.getElementById('select-workplace').addEventListener('change', applyFilters);
        document.getElementById('select-gender').addEventListener('change', applyFilters);
        document.getElementById('select-favorite').addEventListener('change', applyFilters);

        async function openReviews(adminId){
            const response = await fetch(`/fitLink/api/review/list?adminId=${adminId}`);
            const reviews = await response.json();

            const reviewBox = document.getElementById("review-list");
            reviewBox.innerHTML = "";

            if (reviews.length === 0) {
                reviewBox.innerHTML = `
            <p class="text-center text-muted">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
            } else {
                reviews.forEach(r => {
                    reviewBox.innerHTML += `
                <div class="border rounded p-2 mb-2">
                    <div class="fw-bold">â­ ${r.rating}ì </div>
                    <div>${r.content}</div>
                    <div class="text-muted small mt-1">${r.created_at}</div>
                </div>
            `;
                });
            }

            const modal = new bootstrap.Modal(document.getElementById("reviewModal"));
            modal.show();
        }

        function openCertificateModal(fileName){
            const modalImg = document.getElementById("certificate-image");

            modalImg.src = "/upload/certificates/" + fileName; // ì •ì  ë¦¬ì†ŒìŠ¤ ë§¤í•‘ëœ ê²½ë¡œ

            const modal = new bootstrap.Modal(document.getElementById("certificateModal"));
            modal.show();

        }

        function openChat(adminId, adminName) {
            location.href = `/fitLink/chat?adminId=${adminId}&name=${adminName}`;
        }

        function reservation(adminId, adminName){
            alert("* ì˜ˆì•½ì€ ì·¨ì†Œí•˜ì‹œë©´ ìœ„ì•½ê¸ˆì„ ë¬¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì‹ ì¤‘íˆ ì˜ˆì•½í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. \n\n * í•´ë‹¹ ì„ ìƒë‹˜ì´ ë§ëŠ”ì§€ ë‹¤ì‹œí•œë²ˆ ì²´í¬í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

            document.getElementById("selectTrainerId").value = adminId;

            const name = document.getElementById("selectedTrainerName");
            if(name){
                name.textContent = `-${adminName} ì„ ìƒë‹˜`;
            }

            // í¼ ì´ˆê¸°í™”
            document.getElementById("reservationForm").reset();

            // ì‹œê°„ UI ì´ˆê¸°í™”
            const timeSelect = document.getElementById("selectTime");
            timeSelect.selectedIndex = 0;
            clearTimeOptions();

            const today = new Date().toISOString().split("T")[0];
            document.getElementById("selectDate").setAttribute("min", today);

            const modal = new bootstrap.Modal(document.getElementById("reservationModal"));
            modal.show();
        }

        async function saveReservation(event){
            event.preventDefault();  // form ê¸°ë³¸ submit ë§‰ê¸°

            const adminId = document.getElementById("selectTrainerId").value;
            const name = document.getElementById("userName").value.trim();
            const phone = document.getElementById("userPhone").value.trim();
            const date = document.getElementById("selectDate").value;
            const time = document.getElementById("selectTime").value;
            const checkIn = `${date}T${time}:00`;
            const checkOut = `${date}T${(parseInt(time.substring(0,2)) + 1).toString().padStart(2,'0')}:00`;

            if (!date || !time || !name || !phone) {
                alert("ë¹ˆì¹¸ì—†ì´ ëª¨ë‘ ì…ë ¥ ì™„ë£Œí•´ ì£¼ì‹­ì‹œì˜¤.");
                return false;
            }

            const reservationData = {
                adminId: adminId,
                userName: name,
                userPhone: phone,
                checkIn,   // yyyy-MM-dd
                checkOut     // HH:mm
            };

            console.log("ì˜ˆì•½ ë°ì´í„°:", reservationData);

            try{
                const res = await fetch('/fitLink/api/reservation', {
                    method : 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    body: JSON.stringify(reservationData)
                });

                console.log("ì˜ˆì•½ ì‘ë‹µ status:", res.status);
                const text = await res.text();
                console.log("ì˜ˆì•½ ì‘ë‹µ body:", text);

                if(res.ok){
                    alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadReservedTimes(); //  ì˜ˆì•½ ì¦‰ì‹œ ë°˜ì˜
                    const modelEl = document.getElementById("reservationModal");
                    bootstrap.Modal.getInstance(modelEl).hide();
                    document.getElementById("reservationForm").reset();
                } else {
                    alert("ì˜ˆì•½ ì‹¤íŒ¨ (" + res.status + ")");
                }

            } catch (e){
                console.error(e);
                alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ , ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ ë°”ëë‹ˆë‹¤.");
            }

            return false;
            // bootstrap.Modal.getInstance(document.getElementById("reservationModal")).hide();


            // ğŸ’¡ ì„œë²„ì— REST ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            /*
            fetch('/reservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reservationData)
            }).then(res => {
                if(res.ok) alert("ì˜ˆì•½ ì™„ë£Œ!");
                else alert("ì˜ˆì•½ ì‹¤íŒ¨..");
            });
            */

        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ìƒì„±
        document.addEventListener("DOMContentLoaded", initializeMap);
        // kakao.maps.load(function() {
        //     initializeMap();
        // });

    </script>

    <script>
        function clearTimeOptions() {
            const timeSelect = document.getElementById("selectTime");
            [...timeSelect.options].forEach(opt => {
                opt.disabled = false;       // disabled ì´ˆê¸°í™”
                opt.style.color = "";       // ìƒ‰ìƒ ì´ˆê¸°í™”
                if (!opt.value) return;

                // (ì˜ˆì•½ë¶ˆê°€) í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
                opt.textContent = opt.textContent.replace(" (ì˜ˆì•½ë¶ˆê°€)", "");

                // í˜¹ì‹œ ë‚¨ì€ ê²ƒì´ ìˆìœ¼ë©´ ì™„ì „íˆ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
                opt.textContent = opt.value;
            });
        }

        async function loadReservedTimes() {
            const adminId = document.getElementById("selectTrainerId").value;
            const date = document.getElementById("selectDate").value;

            console.log("ğŸ”¹ loadReservedTimes í˜¸ì¶œë¨");
            console.log("ë³´ë‚¸ adminId:", adminId);
            console.log("ë³´ë‚¸ date:", date);

            if (!adminId || !date) return;

            clearTimeOptions();
            reservedTimes = [];

            const timeSelect = document.getElementById("selectTime");
            const options = [...timeSelect.options]; // â­ í•„ìˆ˜ ì¶”ê°€

            const today = new Date().toISOString().split("T")[0];
            if (date === today) {
                const nowHour = new Date().getHours();

                options.forEach(opt => {
                    if (!opt.value) return;
                    const hour = parseInt(opt.value.substring(0, 2));

                    if (hour <= nowHour) {
                        opt.disabled = true;
                        opt.textContent = `${opt.value} (ì˜ˆì•½ ë¶ˆê°€)`;
                        opt.style.color = "#aaa";
                    }
                });
            }

            try {
                const res = await fetch(`/fitLink/api/reservation/times?adminId=${adminId}&date=${date}`, {
                    headers: { "Cache-Control": "no-cache" }
                });

                const reservedTimes = await res.json();
                console.log("ì„œë²„ì—ì„œ ë°›ì€ ì˜ˆì•½ ì‹œê°„:", reservedTimes);

                reservedTimes.forEach(time => {
                    const opt = options.find(o => o.value === time.trim());
                    if (opt) {
                        opt.disabled = true;
                        opt.textContent = `${time.trim()} (ì˜ˆì•½ë¶ˆê°€)`;
                        opt.style.color = "#888";
                    }
                });

            } catch (e) {
                console.error("ì˜ˆì•½ ì‹œê°„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }




        document.addEventListener("DOMContentLoaded", () => {
            const dateInput = document.getElementById("selectDate");
            if (dateInput) {
                dateInput.addEventListener("change", () => {

                    console.log("ğŸ“Œ ë‚ ì§œ ë³€ê²½ â†’ ì‹œê°„ëª©ë¡ ì´ˆê¸°í™”ë§Œ ì‹¤í–‰");

                    document.getElementById("selectTime").selectedIndex = 0;
                    clearTimeOptions();  // UI ì´ˆê¸°í™” ì™„ë£Œ

                    // adminIdê°€ ìˆì–´ë„ ì—†ì–´ë„ ìƒê´€ì—†ì´ ì˜ˆì•½ ì¡°íšŒ ì‹¤í–‰
                    loadReservedTimes();  // ì¡°ê±´ ì œê±°
                });
            }
        });
    </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- í›„ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">í›„ê¸° ëª©ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="review-list">
                    <!-- í›„ê¸° ë‚´ìš©ì´ JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ìê²©ì¦ ëª¨ë‹¬ -->
    <div class="modal fade" id="certificateModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìê²©ì¦ ì´ë¯¸ì§€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">
                    <img id="certificate-image" src=""
                         style="max-width:50%; border-radius:10px;">
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ˜ì—… ì˜ˆì•½ ëª¨ë‹¬ -->
    <div class="modal fade" id="reservationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">ìˆ˜ì—… ì˜ˆì•½ <small class="text-muted ms-2" id="selectedTrainerName"></small></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- form ìœ¼ë¡œ ê°ì‹¸ê¸° -->
                <form id="reservationForm" onsubmit="return saveReservation(event)">
                    <div class="modal-body">
                        <input type="hidden" id="selectTrainerId" name="adminId">

                        <label class="form-label fw-bold">ì´ë¦„</label>
                        <input type="text" id="userName" name="userName"
                               class="form-control mb-3" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">

                        <label class="form-label fw-bold">íœ´ëŒ€í° ë²ˆí˜¸</label>
                        <input type="text" id="userPhone" name="userPhone"
                               class="form-control mb-3" placeholder="010-0000-0000">

                        <label class="form-label fw-bold">ë‚ ì§œ ì„ íƒ</label>
                        <input type="date" id="selectDate" name="date"
                               class="form-control mb-3">

                         <label class="form-label fw-bold">ì‹œê°„ ì„ íƒ</label>
                        <select id="selectTime" name="time" class="form-select">
                            <option value="">ì‹œê°„ ì„ íƒ</option>
                            <option>09:00</option>
                            <option>10:00</option>
                            <option>11:00</option>
                            <option>12:00</option>
                            <option>13:00</option>
                            <option>14:00</option>
                            <option>15:00</option>
                            <option>16:00</option>
                            <option>17:00</option>
                            <option>18:00</option>
                            <option>19:00</option>
                            <option>20:00</option>
                            <option>21:00</option>
                            <option>22:00</option>
                            <option>23:00</option>
                        </select>
                    </div>
                        <button class="btn btn-primary" type="submit">ì˜ˆì•½í•˜ê¸°</button>
                </form>

            </div>
        </div>
    </div>
</body>
</html>